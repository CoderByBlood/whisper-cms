{% extends "layout/base.html" %}
{% block title %}Install â€” Running{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold mb-4">Installingâ€¦</h1>

<ol id="log" class="space-y-1 text-sm">
  <li>Startingâ€¦</li>
</ol>

<script>
// 1) Kick off the run (idempotent server-side)
fetch("/install/run", { method: "POST" }).catch(()=>{});

// 2) Connect to SSE and append messages
const log = document.getElementById("log");
const es  = new EventSource("/install/progress");

es.onmessage = (ev) => {
  try {
    const msg = JSON.parse(ev.data);
    let text = "";
    switch (msg.type) {
      case "Begin": text = `â–¶ ${msg.data}`; break;
      case "Ok":    text = `âœ” ${msg.data}`; break;
      case "Info":  text = `â€¦ ${msg.data}`; break;
      case "Fail":  text = `âœ– ${msg.data[0]} â€” ${msg.data[1]}`; break;
      case "Done":
        text = "ðŸŽ‰ Install complete"; 
        // Optionally redirect to Done page:
        setTimeout(() => { window.location.href = "/install/done"; }, 600);
        break;
      default: text = ev.data;
    }
    const li = document.createElement("li");
    li.textContent = text;
    log.appendChild(li);
  } catch {
    const li = document.createElement("li");
    li.textContent = ev.data;
    log.appendChild(li);
  }
};
</script>
{% endblock %}